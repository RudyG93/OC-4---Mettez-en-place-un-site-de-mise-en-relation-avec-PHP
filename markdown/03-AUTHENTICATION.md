# üîê 03 - SYST√àME D'AUTHENTIFICATION

## Vue d'ensemble

Le syst√®me d'authentification de TomTroc permet :
- ‚úÖ Inscription de nouveaux utilisateurs
- ‚úÖ Connexion s√©curis√©e
- ‚úÖ D√©connexion
- ‚úÖ Protection des pages priv√©es
- ‚úÖ Gestion des sessions
- ‚úÖ Stockage s√©curis√© des mots de passe

---

## Architecture

### Composants

```
AuthController (app/controller/)
    ‚îú‚îÄ‚îÄ register() - Inscription
    ‚îú‚îÄ‚îÄ login() - Connexion
    ‚îî‚îÄ‚îÄ logout() - D√©connexion

UserManager (app/model/manager/)
    ‚îú‚îÄ‚îÄ createUser() - Cr√©er utilisateur
    ‚îú‚îÄ‚îÄ getUserByEmail() - R√©cup√©rer par email
    ‚îî‚îÄ‚îÄ authenticate() - V√©rifier credentials

User (app/model/entity/)
    ‚îú‚îÄ‚îÄ Propri√©t√©s (id, username, email, password...)
    ‚îî‚îÄ‚îÄ M√©thodes getter/setter

Session (app/core/)
    ‚îú‚îÄ‚îÄ Gestion session PHP
    ‚îú‚îÄ‚îÄ Tokens CSRF
    ‚îî‚îÄ‚îÄ Messages flash
```

---

## Inscription

### Route

```
GET/POST /register
Controller: AuthController::register()
Vue: app/view/auth/register.php
```

### Processus d'inscription

#### 1. Affichage du formulaire

```php
public function register() {
    // Si d√©j√† connect√©, rediriger
    if (Session::get('user_id')) {
        return $this->redirect('mon-compte');
    }
    
    // Afficher le formulaire
    $this->render('auth/register');
}
```

#### 2. Soumission du formulaire

**Champs requis** :
- `username` : Nom d'utilisateur (min 3 caract√®res)
- `email` : Email valide
- `password` : Mot de passe (min 8 caract√®res)
- `password_confirm` : Confirmation mot de passe
- `csrf_token` : Token de s√©curit√©

**Validation** :
```php
// V√©rifier le token CSRF
if (!Session::validateCsrfToken($_POST['csrf_token'])) {
    Session::setFlash('error', 'Token de s√©curit√© invalide');
    return $this->redirect('register');
}

// V√©rifier les champs requis
if (empty($username) || empty($email) || empty($password)) {
    Session::setFlash('error', 'Tous les champs sont requis');
    return $this->redirect('register');
}

// V√©rifier longueur username
if (strlen($username) < 3) {
    Session::setFlash('error', 'Le pseudo doit faire au moins 3 caract√®res');
    return $this->redirect('register');
}

// V√©rifier format email
if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
    Session::setFlash('error', 'Email invalide');
    return $this->redirect('register');
}

// V√©rifier longueur mot de passe
if (strlen($password) < 8) {
    Session::setFlash('error', 'Le mot de passe doit faire au moins 8 caract√®res');
    return $this->redirect('register');
}

// V√©rifier confirmation mot de passe
if ($password !== $passwordConfirm) {
    Session::setFlash('error', 'Les mots de passe ne correspondent pas');
    return $this->redirect('register');
}
```

#### 3. V√©rification unicit√© email

```php
$existingUser = $this->userManager->getUserByEmail($email);
if ($existingUser) {
    Session::setFlash('error', 'Cet email est d√©j√† utilis√©');
    return $this->redirect('register');
}
```

#### 4. Cr√©ation de l'utilisateur

```php
$userId = $this->userManager->createUser([
    'username' => $username,
    'email' => $email,
    'password' => $password  // Sera hash√© dans createUser()
]);
```

**Dans UserManager::createUser()** :

```php
public function createUser($data) {
    // Hasher le mot de passe
    $hashedPassword = password_hash($data['password'], PASSWORD_DEFAULT);
    
    // Ins√©rer dans la BDD
    $stmt = $this->db->prepare(
        "INSERT INTO users (username, email, password, created_at) 
         VALUES (?, ?, ?, NOW())"
    );
    
    $stmt->execute([
        $data['username'],
        $data['email'],
        $hashedPassword
    ]);
    
    return $this->db->lastInsertId();
}
```

#### 5. Connexion automatique

```php
// Stocker l'utilisateur en session
Session::set('user_id', $userId);
Session::set('username', $username);
Session::set('email', $email);

Session::setFlash('success', 'Inscription r√©ussie ! Bienvenue ' . $username);
$this->redirect('mon-compte');
```

### Formulaire d'inscription

```html
<form method="POST" action="<?= url('register') ?>">
    <!-- Token CSRF -->
    <input type="hidden" name="csrf_token" 
           value="<?= Session::generateCsrfToken() ?>">
    
    <!-- Pseudo -->
    <div class="form-group">
        <label for="username">Pseudo</label>
        <input type="text" id="username" name="username" 
               required minlength="3">
    </div>
    
    <!-- Email -->
    <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required>
    </div>
    
    <!-- Mot de passe -->
    <div class="form-group">
        <label for="password">Mot de passe</label>
        <input type="password" id="password" name="password" 
               required minlength="8">
    </div>
    
    <!-- Confirmation -->
    <div class="form-group">
        <label for="password_confirm">Confirmer le mot de passe</label>
        <input type="password" id="password_confirm" 
               name="password_confirm" required>
    </div>
    
    <button type="submit">S'inscrire</button>
</form>
```

---

## Connexion

### Route

```
GET/POST /login
Controller: AuthController::login()
Vue: app/view/auth/login.php
```

### Processus de connexion

#### 1. Affichage du formulaire

```php
public function login() {
    // Si d√©j√† connect√©, rediriger
    if (Session::get('user_id')) {
        return $this->redirect('mon-compte');
    }
    
    $this->render('auth/login');
}
```

#### 2. Soumission du formulaire

**Champs requis** :
- `email` : Email
- `password` : Mot de passe
- `csrf_token` : Token CSRF

**Validation** :
```php
// V√©rifier token CSRF
if (!Session::validateCsrfToken($_POST['csrf_token'])) {
    Session::setFlash('error', 'Token invalide');
    return $this->redirect('login');
}

// V√©rifier champs remplis
if (empty($email) || empty($password)) {
    Session::setFlash('error', 'Email et mot de passe requis');
    return $this->redirect('login');
}
```

#### 3. V√©rification des identifiants

```php
$user = $this->userManager->authenticate($email, $password);

if (!$user) {
    Session::setFlash('error', 'Email ou mot de passe incorrect');
    return $this->redirect('login');
}
```

**Dans UserManager::authenticate()** :

```php
public function authenticate($email, $password) {
    // R√©cup√©rer l'utilisateur par email
    $stmt = $this->db->prepare(
        "SELECT * FROM users WHERE email = ?"
    );
    $stmt->execute([$email]);
    $data = $stmt->fetch();
    
    if (!$data) {
        return null; // Email non trouv√©
    }
    
    // V√©rifier le mot de passe
    if (!password_verify($password, $data['password'])) {
        return null; // Mot de passe incorrect
    }
    
    // Cr√©er et retourner l'entit√© User
    $user = new User();
    $user->hydrate($data);
    return $user;
}
```

#### 4. Cr√©ation de la session

```php
// Stocker les infos utilisateur
Session::set('user_id', $user->getId());
Session::set('username', $user->getUsername());
Session::set('email', $user->getEmail());

// Message de succ√®s
Session::setFlash('success', 'Connexion r√©ussie !');

// Rediriger vers le compte
$this->redirect('mon-compte');
```

### Formulaire de connexion

```html
<form method="POST" action="<?= url('login') ?>">
    <input type="hidden" name="csrf_token" 
           value="<?= Session::generateCsrfToken() ?>">
    
    <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required>
    </div>
    
    <div class="form-group">
        <label for="password">Mot de passe</label>
        <input type="password" id="password" name="password" required>
    </div>
    
    <button type="submit">Se connecter</button>
    
    <p>Pas encore de compte ? 
       <a href="<?= url('register') ?>">S'inscrire</a>
    </p>
</form>
```

---

## D√©connexion

### Route

```
GET /logout
Controller: AuthController::logout()
```

### Processus

```php
public function logout() {
    // D√©truire toutes les donn√©es de session
    Session::destroy();
    
    // Message de confirmation
    Session::setFlash('success', 'Vous √™tes d√©connect√©');
    
    // Rediriger vers l'accueil
    $this->redirect('home');
}
```

**Dans Session::destroy()** :

```php
public static function destroy() {
    // Supprimer toutes les variables
    $_SESSION = [];
    
    // D√©truire le cookie de session
    if (isset($_COOKIE[session_name()])) {
        setcookie(session_name(), '', time() - 3600, '/');
    }
    
    // D√©truire la session
    session_destroy();
    
    // Red√©marrer une nouvelle session
    session_start();
}
```

---

## Protection des pages

### V√©rifier si l'utilisateur est connect√©

#### M√©thode 1 : Dans le contr√¥leur

```php
public function myBooks() {
    // V√©rifier si connect√©
    if (!Session::get('user_id')) {
        Session::setFlash('error', 'Vous devez √™tre connect√©');
        return $this->redirect('login');
    }
    
    // Suite du code...
}
```

#### M√©thode 2 : Helper requireAuth()

```php
public function myBooks() {
    // Lance une exception si non connect√©
    requireAuth();
    
    // Suite du code...
}
```

**Dans helpers.php** :

```php
function requireAuth() {
    if (!Session::get('user_id')) {
        Session::setFlash('error', 'Vous devez √™tre connect√©');
        redirect('login');
        exit;
    }
}
```

### V√©rifier la propri√©t√© d'une ressource

```php
public function edit($id) {
    requireAuth(); // Doit √™tre connect√©
    
    $book = $this->bookManager->getBookById($id);
    
    // V√©rifier que c'est bien son livre
    if ($book->getUserId() !== Session::get('user_id')) {
        Session::setFlash('error', 'Vous ne pouvez pas modifier ce livre');
        return $this->redirect('book/my-books');
    }
    
    // Suite du code...
}
```

---

## S√©curit√© des mots de passe

### Hachage avec password_hash()

```php
// Lors de l'inscription
$hashedPassword = password_hash($password, PASSWORD_DEFAULT);

// PASSWORD_DEFAULT utilise bcrypt
// G√©n√®re automatiquement un salt unique
// Co√ªt adaptatif selon la puissance du serveur
```

**R√©sultat** :
```
$2y$10$abcdefghijklmnopqrstuv...
‚îî‚î¨‚îò‚îî‚î¨‚îò‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò
 ‚îÇ  ‚îÇ       ‚îÇ              ‚îÇ
 ‚îÇ  ‚îÇ       ‚îÇ              ‚îî‚îÄ Hash (31 caract√®res)
 ‚îÇ  ‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Salt (22 caract√®res)
 ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Co√ªt (10)
 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Algorithme (bcrypt)
```

### V√©rification avec password_verify()

```php
// Lors de la connexion
if (password_verify($passwordSaisi, $passwordHash√©)) {
    // Mot de passe correct
} else {
    // Mot de passe incorrect
}
```

### Bonnes pratiques

‚úÖ **√Ä FAIRE** :
- Utiliser `password_hash()` avec `PASSWORD_DEFAULT`
- Ne jamais stocker les mots de passe en clair
- Hasher c√¥t√© serveur uniquement
- Exiger minimum 8 caract√®res

‚ùå **√Ä √âVITER** :
- MD5 ou SHA1 (obsol√®tes)
- Hash sans salt
- Stocker les mots de passe en clair
- Envoyer les mots de passe par email

---

## Gestion des sessions

### Configuration s√©curis√©e

**Dans Session.php (constructeur)** :

```php
public function __construct() {
    if (session_status() === PHP_SESSION_NONE) {
        // Configuration s√©curis√©e
        ini_set('session.cookie_httponly', 1);
        ini_set('session.use_only_cookies', 1);
        ini_set('session.cookie_samesite', 'Lax');
        
        session_start();
    }
}
```

**Explications** :
- `cookie_httponly` : Emp√™che JavaScript d'acc√©der au cookie
- `use_only_cookies` : N'accepte que les cookies (pas d'URL)
- `cookie_samesite` : Protection CSRF suppl√©mentaire

### Stocker des donn√©es

```php
// Stocker
Session::set('user_id', 42);
Session::set('cart', ['item1', 'item2']);

// R√©cup√©rer
$userId = Session::get('user_id');
$cart = Session::get('cart', []); // Valeur par d√©faut

// V√©rifier existence
if (Session::has('user_id')) {
    // Utilisateur connect√©
}

// Supprimer
Session::remove('user_id');
```

### Messages flash

Messages affich√©s une seule fois :

```php
// D√©finir
Session::setFlash('success', 'Op√©ration r√©ussie !');
Session::setFlash('error', 'Une erreur est survenue');
Session::setFlash('info', 'Information importante');

// Afficher (dans la vue)
<?php if ($flash = Session::getFlash('success')): ?>
    <div class="alert alert-success"><?= h($flash) ?></div>
<?php endif; ?>

// Le message est automatiquement supprim√© apr√®s affichage
```

---

## Protection CSRF

### Principe

**CSRF** (Cross-Site Request Forgery) : Attaque o√π un site malveillant fait ex√©cuter une action √† votre insu.

**Protection** : Token unique par session, v√©rifi√© √† chaque requ√™te POST.

### G√©n√©ration du token

```php
// G√©n√®re un token al√©atoire unique
$token = Session::generateCsrfToken();
```

**Dans Session.php** :

```php
public static function generateCsrfToken() {
    if (!isset($_SESSION['csrf_token'])) {
        $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
    }
    return $_SESSION['csrf_token'];
}
```

### Utilisation dans les formulaires

```html
<form method="POST">
    <input type="hidden" name="csrf_token" 
           value="<?= Session::generateCsrfToken() ?>">
    <!-- Autres champs -->
</form>
```

### Validation c√¥t√© serveur

```php
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // V√©rifier le token
    if (!Session::validateCsrfToken($_POST['csrf_token'])) {
        Session::setFlash('error', 'Token de s√©curit√© invalide');
        return $this->redirect('form-page');
    }
    
    // Traiter le formulaire...
}
```

**Dans Session.php** :

```php
public static function validateCsrfToken($token) {
    return isset($_SESSION['csrf_token']) 
        && hash_equals($_SESSION['csrf_token'], $token);
}
```

**Note** : `hash_equals()` √©vite les attaques par timing.

---

## Navigation conditionnelle

### Dans le layout (header)

```php
<?php if (Session::get('user_id')): ?>
    <!-- Utilisateur connect√© -->
    <nav>
        <a href="<?= url('mon-compte') ?>">Mon compte</a>
        <a href="<?= url('book/my-books') ?>">Ma biblioth√®que</a>
        <a href="<?= url('messages') ?>">
            Messages
            <?php if ($unreadCount = Session::get('unread_messages', 0)): ?>
                <span class="badge"><?= $unreadCount ?></span>
            <?php endif; ?>
        </a>
        <a href="<?= url('logout') ?>">D√©connexion</a>
    </nav>
<?php else: ?>
    <!-- Utilisateur non connect√© -->
    <nav>
        <a href="<?= url('login') ?>">Connexion</a>
        <a href="<?= url('register') ?>">Inscription</a>
    </nav>
<?php endif; ?>
```

---

## Tests et d√©bogage

### Tester l'inscription

1. Aller sur `/register`
2. Remplir le formulaire
3. V√©rifier la BDD : `SELECT * FROM users ORDER BY id DESC LIMIT 1`
4. V√©rifier que le mot de passe est hash√©

### Tester la connexion

1. Aller sur `/login`
2. Email : `alice@example.com`
3. Password : `password123`
4. V√©rifier redirection vers `/mon-compte`
5. V√©rifier session : `var_dump($_SESSION)`

### Tester la d√©connexion

1. Aller sur `/logout`
2. V√©rifier redirection vers `/`
3. V√©rifier session vide
4. V√©rifier impossibilit√© d'acc√©der √† `/mon-compte`

### D√©boguer les sessions

```php
// Voir le contenu de la session
echo '<pre>';
var_dump($_SESSION);
echo '</pre>';

// Voir l'ID de session
echo 'Session ID: ' . session_id();
```

---

## Erreurs courantes

### "Headers already sent"

**Cause** : Sortie (echo, espace) avant session_start() ou redirect()

**Solution** :
- V√©rifier qu'il n'y a pas d'espace avant `<?php`
- Utiliser `ob_start()` en d√©but de script

### "Token de s√©curit√© invalide"

**Cause** : Token CSRF manquant ou incorrect

**Solution** :
- V√©rifier que le formulaire contient le champ `csrf_token`
- V√©rifier que la validation est bien appel√©e

### "Call to undefined function password_hash()"

**Cause** : PHP < 5.5

**Solution** : Mettre √† jour PHP (minimum 7.4, recommand√© 8.0+)

---

## Am√©liorations possibles

### Mot de passe oubli√©

1. Formulaire "Mot de passe oubli√©"
2. G√©n√©ration token unique temporaire
3. Envoi email avec lien
4. Page r√©initialisation avec token

### Connexion persistante ("Se souvenir de moi")

1. Cookie avec token longue dur√©e
2. Table `remember_tokens` en BDD
3. V√©rification du token au chargement

### Authentification √† deux facteurs (2FA)

1. G√©n√©ration code 6 chiffres
2. Envoi par SMS ou email
3. V√©rification du code apr√®s mot de passe

### OAuth (Google, Facebook)

1. Int√©gration biblioth√®que OAuth
2. Cr√©ation compte ou liaison compte existant
3. Stockage token d'acc√®s

---

## R√©sum√©

Le syst√®me d'authentification TomTroc offre :

‚úÖ **S√©curit√©** : Hachage bcrypt, CSRF, sessions s√©curis√©es
‚úÖ **Simplicit√©** : API claire et facile √† utiliser
‚úÖ **Fiabilit√©** : Validation compl√®te des donn√©es
‚úÖ **Flexibilit√©** : Extensible facilement

**Prochaine √©tape** : Consulter **04-PROFILS.md** pour la gestion des profils utilisateurs.
